<html>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
<script src="handlebars-1.0.rc.1.js" type="text/javascript"></script>
<script src="ember.prod.js" type="text/javascript"></script>

<script id="handlebars-test-template" type="text/x-handlebars-template">
  <h1>Handlebars</h1>
  <table>
    <tr>
      <th>Name</td>
      <th>Email</td>
      <th>Company</td>
      <th>City</td>
    </tr>  
  {{#rows}}
    <tr>
      <td>{{name}}</td>
      <td>{{email}}</td>
      <td>{{company}}</td>
      <td>{{city}}</td>
    </tr>
  {{/rows}}
  </table>
</script>

<script data-template-name="ember-test-template" type="text/x-handlebars">
  <h1>Ember Template</h1>
  <table>
    <tr>
      <th>Name</td>
      <th>Email</td>
      <th>Company</td>
      <th>City</td>
    </tr>  
  {{#each people}}
    <tr>
      <td>{{name}}</td>
      <td>{{email}}</td>
      <td>{{company}}</td>
      <td>{{city}}</td>
    </tr>
  {{/each}}
  </table>
</script>

<script data-template-name="ember-test-template-unbound-collection" type="text/x-handlebars">
  <h1>Ember Unbound collection</h1>
  <table>
    <tr>
      <th>Name</td>
      <th>Email</td>
      <th>Company</td>
      <th>City</td>
    </tr>  
  {{#collection contentBinding="people" tagName="tbody"}}
    <tr>
      <td>{{unbound view.content.name}}</td>
      <td>{{unbound view.content.email}}</td>
      <td>{{unbound view.content.company}}</td>
      <td>{{unbound view.content.city}}</td>
    </tr>
  {{/collection}}
  </table>
</script>

<script data-template-name="ember-test-template-unbound-each" type="text/x-handlebars">
  <h1>Ember Unbound collection</h1>
  <table>
    <tr>
      <th>Name</td>
      <th>Email</td>
      <th>Company</td>
      <th>City</td>
    </tr>  
  {{#each people}}
    <tr>
      <td>{{unbound name}}</td>
      <td>{{unbound email}}</td>
      <td>{{unbound company}}</td>
      <td>{{unbound city}}</td>
    </tr>
  {{/each}}
  </table>
</script>

<script>

  var data = []

  function renderHandlebars() {

    var source   = $("#handlebars-test-template").html();
    var template = Handlebars.compile(source);

    $('#timings').hide()

    var t0 = new Date()
    rendered = template(data)
    $('#time-taken').html(new Date() - t0)
    t0 = new Date()
    $('#main').html(rendered)
    $('#browser-time-taken').html(new Date() - t0)


    $('#timings').show()
  }


  var Person = Ember.Object.extend({})
  var people = Em.A()

  function renderEmberView(view) {
    var t0 = new Date()
    var v = view;
    Em.run(function(){
      v.appendTo('#main');
    });

    $('#time-taken').html("-");
    $('#browser-time-taken').html(new Date() - t0);
    $('#timings').show();
  }

  function renderEmberTemplate(templateName) {
    if (window.$view) {
      $view.destroy();
      $view = null;
    }
    var view = Ember.View.create({
      templateName: templateName,
      people: people
    });

    renderEmberView(view);
    window.$view = view;
  }

  BenchmarkVM = {
    template: function(templateSpec) {
      // Just add water
      var container = {
        escapeExpression: Handlebars.Utils.escapeExpression,
        invokePartial: Handlebars.VM.invokePartial,
        programs: [],
        program: function(i, fn, data) {
          var programWrapper = this.programs[i];
          if(data) {
            return Handlebars.VM.program(fn, data);
          } else if(programWrapper) {
            return programWrapper;
          } else {
            programWrapper = this.programs[i] = Handlebars.VM.program(fn);
            return programWrapper;
          }
        },
        programWithDepth: Handlebars.VM.programWithDepth,
        noop: Handlebars.VM.noop
      };

      return function(context, options) {
        options = options || {};
        return templateSpec.call(container, Handlebars, context, options.helpers, options.partials, options.data);
      };
    },

    programWithDepth: function(fn, data, $depth) {
      var args = Array.prototype.slice.call(arguments, 2);

      return function(context, options) {
        options = options || {};

        return fn.apply(this, [context, options.data || data].concat(args));
      };
    },
    program: function(fn, data) {
      return function(context, options) {
        options = options || {};

        return fn(context, options.data || data);
      };
    },
    noop: function() { return ""; },
    invokePartial: function(partial, name, context, helpers, partials, data) {
      var options = { helpers: helpers, partials: partials, data: data };

      if(partial === undefined) {
        throw new Handlebars.Exception("The partial " + name + " could not be found");
      } else if(partial instanceof Function) {
        return partial(context, options);
      } else if (!Handlebars.compile) {
        throw new Handlebars.Exception("The partial " + name + " could not be compiled when running in runtime-only mode");
      } else {
        partials[name] = Handlebars.compile(partial, {data: data !== undefined});
        return partials[name](context, options);
      }
    }
  };

  function renderEmberPrecompiledTemplate() {
    renderEmberView(Ember.View.create({
      people: people,

      preCompiled: function anonymous(Handlebars,depth0,helpers,partials,data) {
        helpers = helpers || Ember.Handlebars.helpers; data = data || {};
        var buffer = '', stack1, foundHelper, helperMissing=helpers.helperMissing, escapeExpression=this.escapeExpression, self=this;

        function program1(depth0,data) {
          
          var buffer = '', stack1, foundHelper;
          data.buffer.push("\n    <tr>\n      <td>");
          foundHelper = helpers.unbound;
          stack1 = foundHelper ? foundHelper.call(depth0, "name", {hash:{},contexts:[depth0],data:data}) : helperMissing.call(depth0, "unbound", "name", {hash:{},contexts:[depth0],data:data});
          data.buffer.push(escapeExpression(stack1) + "</td>\n      <td>");
          foundHelper = helpers.unbound;
          stack1 = foundHelper ? foundHelper.call(depth0, "email", {hash:{},contexts:[depth0],data:data}) : helperMissing.call(depth0, "unbound", "email", {hash:{},contexts:[depth0],data:data});
          data.buffer.push(escapeExpression(stack1) + "</td>\n      <td>");
          foundHelper = helpers.unbound;
          stack1 = foundHelper ? foundHelper.call(depth0, "company", {hash:{},contexts:[depth0],data:data}) : helperMissing.call(depth0, "unbound", "company", {hash:{},contexts:[depth0],data:data});
          data.buffer.push(escapeExpression(stack1) + "</td>\n      <td>");
          foundHelper = helpers.unbound;
          stack1 = foundHelper ? foundHelper.call(depth0, "city", {hash:{},contexts:[depth0],data:data}) : helperMissing.call(depth0, "unbound", "city", {hash:{},contexts:[depth0],data:data});
          data.buffer.push(escapeExpression(stack1) + "</td>\n    </tr>\n  ");
          return buffer;
        }

        data.buffer.push("\n  <h1>Ember Unbound collection</h1>\n  <table>\n    <tr>\n      <th>Name</td>\n      <th>Email</td>\n      <th>Company</td>\n      <th>City</td>\n    </tr>  \n  ");
        stack1 = {};
        stack1['contentBinding'] = "people";
        stack1['tagName'] = "tbody";
        foundHelper = helpers.collection;

        stack1 = helpers.each.call(depth0, "people", {hash:{},inverse:self.noop,fn:self.program(1, program1, data),contexts:[depth0],data:data});
        Em.get(depth0, 'people').forEach(function (person) { program1(person, data) });

        if(stack1 || stack1 === 0) { data.buffer.push(stack1); }
        data.buffer.push("\n  </table>\n");
        return buffer;
      },

      render: function (buffer) {
        template = BenchmarkVM.template(this.preCompiled) 

        var context = Em.get(this, 'context');
        var keywords = this.cloneKeywords();

        var data = {
          view: this,
          buffer: buffer,
          isRenderData: true,
          keywords: keywords
        };

        var output = template(context, { data: data });

        // If the template returned a string instead of writing to the buffer,
        // push the string onto the buffer.
        if (output !== undefined) { buffer.push(output); }

      }

    }))
  }

  function renderEmberRaw() {
    renderEmberView(Ember.View.create({
      people: people,

      render: function (buffer) {
        buffer.push("<h1>Ember Raw</h1><table><tr><th>Name</td><th>Email</td><th>Company</td><th>City</td></tr>")
        this.get('people').forEach(function (person) {
          buffer.push('<tr>')
          buffer.push('<td>' + person.get('name') + '</td>')
          buffer.push('<td>' + person.get('email') + '</td>')
          buffer.push('<td>' + person.get('company') + '</td>')
          buffer.push('<td>' + person.get('city') + '</td>')
          buffer.push('</tr>')
        })    
        buffer.push("</table>")    
      }

    }))
  }  

  function dataLoaded(loaded) {
    data = {rows: loaded}
    data.rows.forEach(function (row) {
      people.pushObject(Person.create(row))
    })    
    $('#buttons').show()  
  }
</script>

<body>

  <div id='buttons' style='display: none'>
    <button onClick="renderHandlebars()">Render Handlebars</button>
    <button onClick="renderEmberTemplate('ember-test-template')">Render Ember</button>
    <button onClick="renderEmberTemplate('ember-test-template-unbound-each')">Render Ember (Unbound collection)</button>
    <button onClick="renderEmberTemplate('ember-test-template-unbound-collection')">Render Ember (Unbound each)</button>
    <button onClick="renderEmberPrecompiledTemplate()">Render Ember (Precompiled)</button>
    <button onClick="renderEmberRaw()">Render Ember (Raw)</button>
  </div>

  <div id='timings' style='display: none'>
    Handlebars Rendering: <span id='time-taken'></span>
    <br>
    Browser Rendering: <span id='browser-time-taken'></span>

    <hr>
  </div>

  <div id='main'>
  </div>

</body>

<script src="data.js" type="text/javascript"></script>
</html>
